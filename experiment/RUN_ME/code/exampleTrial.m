% One example trial, stops between each stimuli to allow time to explain the subject about what he saw.
% trials - a list of trials generated by "getTrials", each includes the stimuli and their timing.
% is_reach - 1=sub responds with reaching , 0=responds with keybaord.
% p - all experiment's parameters.
function [p] = exampleTrial(trials, is_reach, p)

    % Shorter durations to avoide missing the screen flip.
    fix_duration = p.FIX_DURATION - p.REF_RATE_SEC * 3 / 4;
    mask1_duration = p.MASK1_DURATION - p.REF_RATE_SEC * 3 / 4;
    mask2_duration = p.MASK2_DURATION - p.REF_RATE_SEC * 3 / 4;
    prime_duration = p.PRIME_DURATION - p.REF_RATE_SEC * 3 / 4;
    mask3_duration = p.MASK3_DURATION - p.REF_RATE_SEC * 3 / 4;

    try
        % Set prime font now to save run times.
        Screen('TextFont',p.w, p.HAND_FONT_TYPE);
        Screen('TextSize', p.w, p.HAND_FONT_SIZE);
        
        % Make masks slides.
        mask1 = getTextureFromHD(p.MASKS(trials.mask1(1)), p);
        mask2 = getTextureFromHD(p.MASKS(trials.mask2(1)), p);
        mask3 = getTextureFromHD(p.MASKS(trials.mask3(1)), p);

        % Fixation
        times = showFixation(is_reach, p);

        % Mask 1
        Screen('DrawTexture',p.w, mask1);
        [~,times] = Screen('Flip', p.w, times + fix_duration);

        % Mask 2
        Screen('DrawTexture',p.w, mask2);
        [~,times] = Screen('Flip', p.w, times + mask1_duration);

        % Prime
        Screen('DrawTexture',p.w, p.CATEGOR_TXTR); % Shows categor answers with word.
        DrawFormattedText(p.w, double('תיק'), 'center', (p.SCREEN_HEIGHT/2+3), [0 0 0]);
        [~,times] = Screen('Flip', p.w, times + mask2_duration, 1);
        mask_3_disp_time = times + prime_duration;

        % Mask 3
        Screen('DrawTexture',p.w, mask3);
        [~,times] = Screen('Flip', p.w, mask_3_disp_time);

        % Target
        Screen('TextFont',p.w, p.FONT_TYPE); % Set target font.
        Screen('TextSize', p.w, p.FONT_SIZE);
        Screen('DrawTexture',p.w, p.CATEGOR_TXTR); % Shows categor answers with target.
        DrawFormattedText(p.w, double('עלה'), 'center', (p.SCREEN_HEIGHT/2+3), [0 0 0]);
        [~,times] = Screen('Flip', p.w, times + mask3_duration, 1);
        
        % Waits for key press.
        getInput('instruction',p);

        % Prime recognition.
        txtr_num = getTextureFromHD(p.RECOG_SCREEN, p);
        Screen('DrawTexture',p.w, txtr_num);
        Screen('TextSize', p.w, p.RECOG_FONT_SIZE);
        DrawFormattedText(p.w, double('תיק'), p.SCREEN_WIDTH*2/7, p.SCREEN_HEIGHT*5/16, [0 0 0]);
        DrawFormattedText(p.w, double('ספל'), p.SCREEN_WIDTH*21/32, p.SCREEN_HEIGHT*5/16, [0 0 0]);
        [~,times] = Screen('Flip', p.w, 0, 1);
        Screen('close', txtr_num);
        
        % Waits for key press.
        getInput('instruction',p);

        % PAS
        times(9) = showTexture(p.PAS_SCREEN, p);
        [pas, pas_time] = getInput('pas', p);
        
        % Close mask textures.
        Screen('close',[mask1 mask2 mask3]);
    catch e % if error occured, saves data before exit.
        fixOutput(p);
        rethrow(e);
    end
end